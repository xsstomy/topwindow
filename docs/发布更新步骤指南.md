# TopWindow 发布更新步骤指南

本文档详细说明了 TopWindow 项目的完整发布更新流程，包括应用更新和网站部署。

## 📋 发布前检查清单

### 1. 版本准备
- [ ] 确认新的 DMG 文件已构建完成
- [ ] DMG 文件命名格式正确：`TopWindow-X.X.X.dmg`
- [ ] 检查应用功能是否正常
- [ ] 确认更新内容已记录

### 2. 环境检查
- [ ] 确认当前在 `topwindow` 项目目录
- [ ] 确认网络连接正常
- [ ] 确认 Wrangler 已配置并登录

## 🚀 发布流程

### 第一步：同步 DMG 到 R2 存储

```bash
cd /Users/xiashishi/github/ios/macosapp/projects/topwindow
npm run sync-dmg
```

**此步骤会：**
1. 🔍 自动查找最新的 DMG 文件
2. 📦 提取版本号（从文件名）
3. 📊 计算文件大小和校验和
4. ⬆️ 上传到 R2 存储的两个位置：
   - `/releases/latest/topwindow-setup.dmg`
   - `/releases/v{version}/topwindow-setup.dmg`
5. 📝 创建并上传 `version.json` 版本信息文件

**示例输出：**
```
🚀 TopWindow DMG Upload Complete!
=======================================
Version: 1.2.1
File: TopWindow-1.2.1.dmg
Size: 4.5MB
Download URL: https://downloads.topwindow.app/releases/latest/topwindow-setup.dmg
Version Info: https://downloads.topwindow.app/releases/latest/version.json
=======================================
```

### 第二步：部署网站

```bash
npm run deploy
```

**此步骤会：**
1. 🔧 运行 `npm run prebuild` 生成构建信息
2. 🏗️ 运行 `npm run build:worker` 构建 Next.js 应用
3. 🚀 运行 `wrangler deploy` 部署到 Cloudflare Workers

**构建信息生成：**
- 版本号：`v{baseVersion}-build.{date}.{time}`
- Git 提交哈希
- 构建时间戳
- 环境信息

## 📁 重要文件说明

### version.json 结构
发布后自动生成的版本信息文件包含：

```json
{
  "version": "1.2.1",
  "releaseDate": "2025-01-11T15:41:00Z",
  "builds": {
    "macos": {
      "filename": "topwindow-setup.dmg",
      "size": "4.5MB",
      "checksum": "sha256:...",
      "url": "https://downloads.topwindow.app/releases/latest/topwindow-setup.dmg"
    }
  },
  "changelog": [
    "Version 1.2.1 release",
    "Performance improvements and bug fixes"
  ]
}
```

### 关键配置文件
- `package.json`: 项目版本号
- `scripts/sync-dmg.sh`: DMG 上传脚本
- `scripts/generate-build-info.js`: 构建信息生成脚本
- `wrangler.jsonc`: Cloudflare Workers 配置

## ⚠️ 注意事项

### 版本号一致性
确保以下三个地方的版本号保持一致：
1. **DMG 文件名**: `TopWindow-1.2.1.dmg`
2. **version.json**: 自动从 DMG 文件名提取
3. **package.json**: 当前版本（如需更新）

### 更新 package.json（可选）
如需更新网站版本号：
```bash
# 小版本更新（1.2.0 -> 1.2.1）
npm version patch

# 中版本更新（1.2.0 -> 1.3.0）
npm version minor

# 大版本更新（1.2.0 -> 2.0.0）
npm version major
```

### 发布顺序很重要
**必须先执行 `npm run sync-dmg`，再执行 `npm run deploy`**
- 网站在部署时会从 R2 获取最新的版本信息
- 如果顺序颠倒，网站可能显示旧的版本信息

## 🔍 验证发布

### 1. 检查 DMG 下载
访问：`https://downloads.topwindow.app/releases/latest/topwindow-setup.dmg`

### 2. 检查版本信息
访问：`https://downloads.topwindow.app/releases/latest/version.json`

### 3. 检查网站
- 访问：`https://topwindow.app`
- 检查下载按钮显示的版本号
- 测试下载功能

### 4. 检查构建信息
访问：`https://topwindow.app/build-info.json`

## 🛠️ 故障排除

### 常见问题

**问题 1**: wrangler 命令未找到
```bash
npm install -g wrangler
wrangler login
```

**问题 2**: R2 上传失败
- 检查网络连接
- 确认 R2 配置正确
- 检查存储空间

**问题 3**: 构建失败
- 清理缓存：`npm run clean`
- 重新安装依赖：`rm -rf node_modules && npm install`

**问题 4**: 版本号不一致
- 检查 DMG 文件名格式
- 手动更新 package.json 版本号

### 回滚操作
如果发布出现问题：

1. **网站回滚**：
   ```bash
   # 重新部署上一个版本
   git checkout [previous-commit]
   npm run deploy
   ```

2. **DMG 回滚**：
   ```bash
   # 上传之前的 DMG 文件
   # 手动指定正确的 DMG 文件路径
   ```

## 📊 发布历史记录

建议在每次发布后记录：
- 发布日期
- 版本号
- 更新内容
- 发布人员
- 备注

这样可以建立完整的发布历史，便于问题追踪和版本管理。

---

## 🎯 快速发布命令总结

```bash
# 完整发布流程
npm run sync-dmg && npm run deploy

# 包含版本号更新的完整流程
npm version patch && npm run sync-dmg && npm run deploy
```

记住：**先同步 DMG，再部署网站！**